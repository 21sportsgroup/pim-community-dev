{% extends 'PimProductBundle::layout.html.twig' %}

{% set title = form.vars.value.id ? 'Edit product'|trans : 'Add product'|trans %}

{% block page_container %}
<div class="container-fluid">

    {% block content %}
    <div class="btn-group">
        <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
            <i class="icon-plus"></i> Add attributes
            <span class="caret"></span>
        </a>
        <div class="dropdown-menu">
            <form method="POST" action="{{ path('pim_product_product_addproductattributes', {'id': product.id}) }}">
                {{ form_widget(attributesForm.attributes) }}
                {{ form_widget(attributesForm._token) }}
                <input type="submit" value="Add" class="btn btn-mini" title="Add attributes"/>
            </form>
        </div>
    </div>

    <form method="POST" class="form-horizontal" action="{{ path('pim_product_product_edit', { id: form.vars.value.id, dataLocale: dataLocale }) }}" {{ form_enctype(form) }}>

        <div class="navigation clearfix navbar-extra navbar-extra-right">
            <div class="row">
                {% if form.vars.value.id %}
                <div class="pull-right">
                    <div class="pull-right">
                        <div class="pull-left btn-group icons-holder">
                            <a class="btn" href="{{ path('pim_product_product_index') }}">{{ "Back to grid" | trans }}</a>
                        </div>
                        <div class="pull-left btn-group icons-holder">
                            <a href="javascript: void(0);" class="btn icons-holder-text" id="btn-delete-product" data-id="{{ form.vars.value.id }}" data-message="{{ 'Are you sure you want to delete this product ?'|trans }}" title="{{ 'Delete'|trans }}"><i class="icon-trash hide-text">{{ 'Remove'|trans }}</i>Delete</a>
                        </div>
                        <div class="pull-left customer-info-top-actions">
                            <div class="btn-group">
                                <a href="{{ path('pim_product_product_index') }}" class="btn">{{ 'Cancel'|trans }}</a>
                                <button type="submit" class="btn btn-primary"><i class="icon-ok icon-white hide-text">Save </i> {{ ' Save'|trans }}</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="pull-left">
                    <div class="customer-info well-small" style="padding-left: 21px;">
                        <div class="customer-content pull-left">
                            <div class="clearfix-oro">
                                <div class="sub-title">{{ 'Products'|trans }}</div>
                                <span class="separator">/</span>
                                <h1 class="usser-name">{{ form.vars.value.sku }}</h1>
                            </div>

                            <ul class="inline">
                                <li><span id="updated" class="label label-warning">{{ 'The product has been updated.'|trans }}</span></li>
                            </ul>

                            <div class="btn-group">
                                <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                                    Displayed channel
                                    <span class="caret"></span>
                                </a>
                                <ul class="dropdown-menu channel">
                                    {% for channel in channels %}
                                        <li><a href="#channel-{{ channel.code }}" data-scope="{{ channel.code }}">{{ channel.name }}</a></li>
                                    {% endfor %}
                                </ul>
                            </div>

                            <div class="btn-group">
                                <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                                    Locale
                                    <span class="caret"></span>
                                </a>
                                <ul class="dropdown-menu">
                                    {% for language in form.vars.value.getActiveLanguages() %}
                                        <li><a href="?dataLocale={{ language.code }}">{{ language.code | trans }}</a></li>
                                    {% endfor %}
                                </ul>
                            </div>

                       </div>
                   </div>
                </div>
                {% else %}
                <div class="pull-left">
                    <div class="customer-info well-small">
                        <div class="customer-content">
                            <h1 class="usser-name">{{ title }}</h1>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="layout-content">


                <div id="form-navbar" class="navbar navbar-static scrollspy-nav">
                    <div class="navbar-inner">
                        <div class="row-fluid">
                            <ul class="nav">
                                <li class="active"><a href="#attributes" data-toggle="tab">{{ 'Attributes' | trans }}</a></li>
                                <li class=""><a href="#variants" data-toggle="tab">{{ 'Variants' | trans }}</a></li>
                                <li class=""><a href="#associations" data-toggle="tab">{{ 'Associations' | trans }}</a></li>
                                <li class=""><a href="#localisations" data-toggle="tab">{{ 'Localisations' | trans }}</a></li>
                                <li class=""><a href="#history" data-toggle="tab">{{ 'History' | trans }}</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="row-fluid tab-content">
                    {% if form.vars.errors|length %}
                        <div class="alert alert-error">
                            {{ form_errors(form) }}
                        </div>
                    {% endif %}
                    <div class="tab-pane active" id="attributes">
                        <div class="span2">
                            <ul class="nav nav-list">
                                {% for group in product.orderedGroups %}
                                <li class="tab{% if loop.index == 1 %} active{% endif %}">
                                    <a href="#tabs-{{group.id}}" data-toggle="tab">{{ group.name|trans }}</a>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="span9 tab-content">
                            {{ form_row(form.id) }}
                            <div class="control-group">
                                {{ form_label(form.sku, null, { 'label_attr': {'class': 'control-label'} }) }}
                                <div class="controls">
                                    {{ form_widget(form.sku, {'attr' : { 'class': 'span4' } }) }}
                                </div>
                            </div>
                            {% set attributeCode = '' %}
                            {% for group in product.orderedGroups %}
                            <div id="tabs-{{ group.id }}" class="tab-pane{% if loop.index == 1 %} active{% endif %}">
                                <h3>{{ group.name|trans }}</h3>
                                <div> {# will generate a <div></div> for first iteration #}
                                    {% for formValue in form.values %}
                                        {% if formValue.vars.value.attribute.group is null %}
                                            {% set groupId = 0 %}
                                        {% else %}
                                            {% set groupId = formValue.vars.value.attribute.group.id %}
                                        {% endif %}
                                        {% if group.id == groupId %}
                                            {% if attributeCode != formValue.vars.value.attribute.code %}
                                                </div>
                                                <div class="{{ formValue.vars.value.attribute.scopable ? 'scopable' : '' }}" data-field="{{ formValue.vars.value.attribute.code }}">
                                            {% endif %}
                                            <div class="control-group">
                                                {{ form_widget(formValue, {'attr': {'data-scope': formValue.vars.value.scope}} ) }}
                                            </div>
                                            {% set attributeCode = formValue.vars.value.attribute.code %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="tab-pane" id="variants"></div>

                    <div class="tab-pane" id="associations"></div>

                    <div class="tab-pane" id="localisations">
                        {{ form_row(form.languages) }}
                    </div>

                    <div class="tab-pane" id="history"></div>

                    {{ form_row(form.id) }}
                    {{ form_row(form._token) }}
            </div>
        </div>
    </form>
    {% endblock %}
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script type="text/javascript" src="{{ asset('bundles/oroui/lib/backbone.bootstrap-modal.js') }}"></script>

    <script type="text/javascript">
    $(function() {
        var updated = false;

        $('#updated').css('display', 'none');
        $('input, textarea, select').change(function(event){
            updated = true;
            $('#updated').css('display', 'inline-block');
            $('input, textarea, select').unbind('change');
        });

        $(window).on('beforeunload', function(){
            if (updated) {
                return "{{ 'You will lose changes to the product if you leave the page.'|trans }}";
            }
        });

        $('button[type="submit"]').click(function(event) {
            $(window).unbind('beforeunload');
        });

        $('select').select2({ allowClear: true });
        $('input.multiselect').select2({ tags: $(this).val() });

        $('.tab-pan .control-group .select2-container').each(function() {
            $(this).addClass('span4');
            $(this).attr('style', 'margin-left:0px');
        });

        $('#btn-delete-product').click(function(event) {
            doAction = function() {
                window.location.href = "{{ path('pim_product_product_remove', { id: form.vars.value.id }) }}";
            };

            if (!_.isUndefined(Backbone.BootstrapModal)) {
                confirm = new Backbone.BootstrapModal({
                    title: "{{ 'Delete Confirmation' | trans }}",
                    content: "{{ 'Are you sure you want to delete this product' | trans }}"
                });
                confirm.on('ok', doAction);
                confirm.open();
            } else if (window.confirm(message)) {
                doAction();
            }
        });

        /**
         * Expand or collpase scopable fields group
         */
        $('.scopable').each(function() {
            $(this).children('.control-group').slice(1).hide();
        });

        $('#attributes').on('click', '.expand', function(event) {
            var field = $(this).data('field');
            $('.scopable[data-field="' + field + '"]').children('.control-group').show();
            $(this)
                .removeClass('expand')
                .addClass('collapse')
            ;
            $(this)
                .children('i')
                .removeClass('icon-chevron-down')
                .addClass('icon-chevron-up')
            ;
        });

        $('#attributes').on('click', '.collapse', function(event) {
            var field = $(this).data('field');
            $('.scopable[data-field="' + field + '"]').children('.control-group').slice(1).hide();
            $(this)
                .removeClass('collapse')
                .addClass('expand')
            ;
            $(this)
                .children('i')
                .removeClass('icon-chevron-up')
                .addClass('icon-chevron-down')
            ;
        });

        /**
         * Move scopable element which is of the selected displayed channel to the top
         * of its group of scopable elements
         */
        $('.channel a').click(function(event) {
            var selectedScope = $(this).data('scope');
            $('.scopable').each(function() {
                var field = $(this).data('field');

                $(this)
                    .find('div[data-scope="' + selectedScope + '"]')
                    .parents('.control-group')
                    .prependTo(this)
                ;

                $(this).children('.control-group').first().show();
                if ($('a[data-field="' + field + '"]').hasClass('expand')) {
                    $(this).children('.control-group').slice(1).hide();
                }
            });
        });

        $('.dropdown-menu').find('form').click(function (e) {
            e.stopPropagation();
        });
        $('#pim_available_product_attributes_attributes').select2('destroy');
    });
    </script>
    <link rel="stylesheet" href="{{ asset('bundles/pimui/css/select2.css') }}" />
{% endblock %}
