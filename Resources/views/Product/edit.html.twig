{% extends 'PimProductBundle::layout.html.twig' %}

{% set title = form.vars.value.id ? 'Edit product'|trans : 'Add product'|trans %}

{% block content %}
{% form_theme form 'PimProductBundle:Form:simple_layout.html.twig' %}

<form method="POST" class="form-horizontal" action="{{ form.vars.value.id ?
    path('pim_product_product_edit', { id: form.vars.value.id, dataLocale: dataLocale }) :
    path('pim_product_product_create', { dataLocale: dataLocale }) }}" {{ form_enctype(form) }}>
    <div class="row-fluid">
        <h3 class="pull-left">{{ title|trans }}</h3>
        <div class="pull-right">
            <span id="updated" class="label label-warning">{{ 'The product has been updated.'|trans }}</span>
            <a class="btn" href="{{ path('pim_product_product_index') }}">
                {{ "Back to list" | trans }}
            </a>
            <div class="btn-group">
                <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                    Displayed channel
                    <span class="caret"></span>
                </a>
                <ul class="dropdown-menu channel">
                    {% for channel in channels %}
                        <li><a href="#channel-{{ channel.code }}" data-scope="{{ channel.code }}">{{ channel.name }}</a></li>
                    {% endfor %}
                </ul>
            </div>
            <div class="btn-group">
                <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                    Locale
                    <span class="caret"></span>
                </a>
                <ul class="dropdown-menu">
                    {% for language in form.vars.value.getActiveLanguages() %}
                        <li><a href="?dataLocale={{ language.code }}">{{ language.fromLocale(app.request.locale) }}</a></li>
                    {% endfor %}
                </ul>
            </div>
            <a class="btn" href="{{ path('pim_product_product_remove', { id: form.vars.value.id }) }}">
                {{ "Delete" | trans }}
            </a>
            <button class="btn btn-primary" type="submit">{{ 'Save'|trans }}</button>
        </div>
    </div>

    <div class="row-fluid">
        <div class="control-group">
            {{ form_label(form.productFamily, 'Family', { 'label_attr': {'class': 'control-label span1'} }) }}
            <div class="controls">
                {{ form_widget(form.productFamily, {'attr' : { 'class': 'span1' }}) }}
            </div>

        </div>
    </div>

    <div id="form-navbar" class="navbar navbar-static scrollspy-nav">
        <div class="navbar-inner">
            <div class="row-fluid">
                <ul class="nav">
                    <li class="active"><a href="#attributes" data-toggle="tab">Attributes</a></li>
                    <li class=""><a href="#localisations" data-toggle="tab">Localisations</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row-fluid tab-content">
        {% if form.vars.errors|length %}
            <div class="alert alert-error">
                {{ form_errors(form) }}
            </div>
        {% endif %}
        <div class="tab-pane active" id="attributes">
            <div id="form-parameters">
                <h3 class="scrollspy-title">Attributes</h3>
            </div>
            <div class="span2">
                <ul class="nav nav-list">
                    {% for group in groups %}
                    <li class="tab{% if loop.index == 1 %} active{% endif %}">
                        <a href="#tabs-{{group.id}}" data-toggle="tab">{{ group.name|trans }}</a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="span9 tab-content">
                {{ form_row(form.id) }}
                <div class="control-group">
                    {{ form_label(form.sku, null, { 'label_attr': {'class': 'control-label'} }) }}
                    <div class="controls">
                        {{ form_widget(form.sku, {'attr' : { 'class': 'span4' } }) }}
                    </div>
                </div>
                {% set attributeCode = '' %}
                {% for group in groups %}
                <div id="tabs-{{ group.id }}" class="tab-pane{% if loop.index == 1 %} active{% endif %}">
                    <h3>{{ group.name|trans }}</h3>
                    <div> {# will generate a <div></div> for first iteration #}
                        {% for formValue in form.values %}
                            {% if group.id == formValue.group.vars.value %}
                                {% if attributeCode != formValue.vars.value.attribute.code %}
                                    </div>
                                    {% if formValue.vars.value.attribute.scopable %}
                                    <a href="#" class="expand" data-field="{{ formValue.vars.value.attribute.code }}"><i class="icon-chevron-down"></i></a>
                                    {% endif %}
                                    <div class="{{ formValue.vars.value.attribute.scopable ? 'scopable' : '' }}" data-field="{{ formValue.vars.value.attribute.code }}">
                                {% endif %}
                                <div class="control-group">
                                    {{ form_label(formValue, formValue.vars.value.attribute.code, { 'label_attr': {'class': 'control-label'} }) }}
                                    <div class="controls">
                                        {{ form_widget(formValue, {'attr': {'data-scope': formValue.vars.value.scope}} ) }}
                                    </div>
                                </div>
                                {% set attributeCode = formValue.vars.value.attribute.code %}
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="tab-pane" id="localisations">
            <div id="form-parameters">
                <h3 class="scrollspy-title">Localisations</h3>
                {{ form_row(form.languages) }}
            </div>
        </div>
        {{ form_row(form.id) }}
        {{ form_row(form._token) }}
    </div>
</form>
{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
    $(function() {
        var updated = false;

        $('#updated').css('display', 'none');
        $('input, textarea, select').change(function(event){
            updated = true;
            $('#updated').css('display', 'inline-block');
            $('input, textarea, select').unbind('change');
        });

        $(window).on('beforeunload', function(){
            if (updated) {
                return "{{ 'You will lose changes to the product if you leave the page.'|trans }}";
            }
        });

        $('button[type="submit"]').click(function(event) {
            $(window).unbind('beforeunload');
        });

        $('select').select2({ allowClear: true });
        $('input.multiselect').select2({ tags: $(this).val() });

        $('.tab-pan .control-group .select2-container').each(function() {
            $(this).addClass('span4');
            $(this).attr('style', 'margin-left:0px');
        });

        /**
         * Expand or collpase scopable fields group
         */
        $('.scopable').each(function() {
            $(this).children('.control-group').slice(1).hide();
        });

        $('#attributes').on('click', '.expand', function(event) {
            var field = $(this).data('field');
            $('.scopable[data-field="' + field + '"]').children('.control-group').show();
            $(this)
                .removeClass('expand')
                .addClass('collapse')
            ;
            $(this)
                .children('i')
                .removeClass('icon-chevron-down')
                .addClass('icon-chevron-up')
            ;
        });

        $('#attributes').on('click', '.collapse', function(event) {
            var field = $(this).data('field');
            $('.scopable[data-field="' + field + '"]').children('.control-group').slice(1).hide();
            $(this)
                .removeClass('collapse')
                .addClass('expand')
            ;
            $(this)
                .children('i')
                .removeClass('icon-chevron-up')
                .addClass('icon-chevron-down')
            ;
        });

        /**
         * Move scopable element which is of the selected displayed channel to the top
         * of its group of scopable elements
         */
        $('.channel a').click(function(event) {
            var selectedScope = $(this).data('scope');
            $('.scopable').each(function() {
                var field = $(this).data('field');

                $(this)
                    .find('div[data-scope="' + selectedScope + '"]')
                    .parents('.control-group')
                    .prependTo(this)
                ;

                $(this).children('.control-group').first().show();
                if ($('a[data-field="' + field + '"]').hasClass('expand')) {
                    $(this).children('.control-group').slice(1).hide();
                }
            });
        });
    });

    </script>
    <link rel="stylesheet" href="{{ asset('bundles/pimui/css/select2.css') }}" />
    <script type="text/javascript" src="{{ asset('bundles/pimui/js/select2.js') }}"></script>
    <script type="text/javascript" src="{{ asset('bundles/pimui/js/jquery-ui-1.10.0.min.js') }}"></script>
{% endblock %}
