{% extends 'PimUIBundle::layout.html.twig' %}

{% block title %}{{ parent() }} {{ "pim.catalog.set.title.edit" | trans }}{% endblock %}

{% block content_menu_more %}
    {{ parent() }}
    <li>
        <a href="{{ path('pim_catalog_productset_index') }}" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-primary" role="button">
            <span class="ui-button-icon-primary ui-icon ui-icon-fugue-ui-button-navigation-back"></span>
            <span class="ui-button-text">{{ "bap.navigation.back-list" | trans }}</span>
        </a>
    </li>
{% endblock %}

{% block content %}

    {% form_theme form 'BapUIBundle:Form:fields.html.twig' %}
    
    <form action="{{ path('pim_catalog_productset_update', { 'id': entity.id }) }}" method="post" {{ form_enctype(form) }}>

        {{ form_errors(form) }}
    
        <div class="form-panel ui-corner-all">
            <h2>{{ "pim.catalog.set.fieldset.general" | trans }}</h2>
            {{ form_row(form.id) }}
            {{ form_row(form.code) }}
        </div>

        <!-- notice -->
        <div class="form-panel ui-corner-all notice">
            <em>{{ "pim.catalog.set.message.demo-view" | trans }}</em>
        </div>

        <!-- set attributes -->
        <div class="fluid-column-wrapper">
            <div class="ui-corner-all form-panel type-group-fields">
    
                <div id="tabs">
                    <h2>{{ "pim.catalog.set.fieldset.group-attribute" | trans }}</h2>
                    <!-- one tab by group -->
                    <ul>
                        {% for group in form.groups %}
                        <li>
                            <span class="ui-icon ui-icon-close">{{ "pim.catalog.set.text.delete-group" | trans }}</span>
                            <a href="#tabs-{{ group.id.vars.value }}">{{ group.title.vars.value }}</a>
                        </li>
                        {% endfor %}
    
                        <a id="add_tab" href="#" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-icon-only" role="button" />
                            <span class="ui-button-icon-primary ui-icon ui-icon-fugue-plus-button"></span>
                            <span class="ui-button-text">{{ "pim.catalog.set.text.add-group" | trans }}</span>
                        </a>
                    </ul>
                    
                    <!-- tabs content -->
                    {% for group in form.groups %}
                    <div id="tabs-{{ group.id.vars.value }}">
                        <ul class="connectedSortable">
                            {{ form_row(group.id) }}
                            {{ form_row(group.code) }}
                            {% for attribute in group.attributes %}
                                <li class="ui-state-default ui-corner-all" id="{{ attribute.id.vars.value }}">
                                    {{ attribute.title.vars.value }} ({{ attribute.code.vars.value }})
                                    {{ form_row(attribute.id) }}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- available attributes -->
        <div class="form-panel ui-corner-all type-available-fields">
            <h2>{{ "pim.catalog.set.fieldset.available-attribute" | trans }}</h2>
            <ul id="available-list" class="connectedSortable">
                {% for field in form.others %}
                    <li class="ui-state-default ui-corner-all" id="{{ field.id.vars.value }}">
                        {{ field.title.vars.value }} ({{ field.code.vars.value }})
                        {{ form_row(field.id) }}
                    </li>
                {% endfor %}
            </ul>
        </div>

        {{ form_widget(form._token) }}

        <input id="edit-form-submit" type="submit" value="{{ "bap.button.save" | trans }}" class="ui-helper-hidden" role="button" aria-disabled="false">

    </form>
    
    <!-- add group dialog -->
    <div id="dialog" title="{{ "pim.catalog.product.text.group-tab" | trans }}">
        <form>
            <fieldset class="ui-helper-reset">
                <label for="tab_title">Code</label>
                <input type="text" name="tab_title" id="tab_title" value="{{ "bap.button.save" | trans }}" class="ui-widget-content ui-corner-all" />
            </fieldset>
        </form>
    </div>

    <div id="dialog-message-delete-group-forbidden" title="{{ "pim.catalog.set.message.group-not-delete" | trans }}" style="display:none">
        <p>
            <span class="ui-icon ui-icon-circle-check" style="float:left; margin:0 7px 50px 0;"></span>
            This group contains fields, <b>please remove them before</b>.
        </p>
    </div>

<script>

function resetListMoves() {
    /* set groups and fields */
    $( ".connectedSortable" ).sortable().disableSelection();
    var $tabs = $( "#tabs" ).tabs();
    var $tab_items = $( "ul:first li", $tabs ).droppable({
        accept: ".connectedSortable li",
        hoverClass: "ui-state-hover",
        drop: function( event, ui ) {
            var $item = $( this );
            var $list = $( $item.find( "a" ).attr( "href" ) )
                .find( ".connectedSortable" );
            ui.draggable.hide( "slow", function() {
                $tabs.tabs( "select", $tab_items.index( $item ) );
                $( this ).appendTo( $list ).show( "slow" );
            });
        }
    });
    
    /* remove a field from set */
    $( ".connectedSortable" ).sortable({
        connectWith: "#available-list",
        placeholder: "ui-state-highlight",
        cursor: "move",
        receive: function(event, ui) {
            ui.item.addClass("add-field").removeClass("remove-field")
            console.log(event);
            console.log(ui);
        }
    }).disableSelection();
    
    /* add an available field to set */
    $( "#available-list" ).sortable({
        connectWith: ".connectedSortable",
        placeholder: "ui-state-highlight",
        cursor: "move",
        receive: function(event, ui) { ui.item.addClass("remove-field").removeClass("add-field") }
    }).disableSelection();
}

$(function() {

    resetListMoves();

    /* add a group */
    var $tab_title_input = $( "#tab_title"),
    $tab_content_input = $( "#tab_content" );
    var tab_counter = 2;

    // tabs init with a custom tab template and an "add" callback filling in the content
    var $tabs = $( "#tabs").tabs({
        tabTemplate: "<li><span class='ui-icon ui-icon-close'>{{ "pim.catalog.set.text.delete-group" | trans }}</span><a href='#{href}'>#{label}</a></li>",
        add: function( event, ui ) {
            var tab_content = '<ul class="connectedSortable">'+
                '<input type="hidden" id="akeneo_catalog_productset_groups_'+tab_counter+'_id" '+
                'name="akeneo_catalog_producttype[groups]['+tab_counter+'][id]">'+
                '<input type="hidden" id="akeneo_catalog_productset_groups_'+tab_counter+'_code" '+
                'name="akeneo_catalog_producttype[groups]['+tab_counter+'][code]" value="'+$tab_title_input.val()+'" />'+
                '</ul>';
            $( ui.panel ).append(tab_content);
            /* aims to drag / drop from and to this new tab */
            resetListMoves();
        }
    });
    
    /* vertical tabs */
    $( "#tabs" ).tabs().addClass( "ui-tabs-vertical ui-helper-clearfix" );
    $( "#tabs li" ).removeClass( "ui-corner-top" ).addClass( "ui-corner-left" );
    
    /* allow to sort tabs */
    $( "#tabs" ).tabs().find( ".ui-tabs-nav" ).sortable({ axis: "x" });

    // modal dialog init: custom buttons and a "close" callback reseting the form inside
    var $dialog = $( "#dialog" ).dialog({
        autoOpen: false,
        modal: true,
        buttons: {
            Add: function() {
                addTab();
                $( this ).dialog( "close" );
            },
            Cancel: function() {
                $( this ).dialog( "close" );
            }
        },
        open: function() {
            $tab_title_input.focus();
        },
        close: function() {
            $form[ 0 ].reset();
        }
    });

    // addTab form: calls addTab function on submit and closes the dialog
    var $form = $( "form", $dialog ).submit(function() {
        addTab();
        $dialog.dialog( "close" );
        return false;
    });

    // actual addTab function: adds new tab using the title input from the form above
    function addTab() {
        var tab_title = $tab_title_input.val() || "Tab " + tab_counter;
        $tabs.tabs( "add", "#tabs-" + tab_counter, tab_title );
        tab_counter++;
    }

    // addTab button: just opens the dialog
    $( "#add_tab" )
        /*.button()*/
        .click(function() {
            $dialog.dialog( "open" );
        });

    // close icon: removing the tab on click
    // note: closable tabs gonna be an option in the future - see http://dev.jqueryui.com/ticket/3924
    $( "#tabs span.ui-icon-close" ).live( "click", function() {
    
    
        /* popup add group doesn't work anymore */
    
        /* can't be deleted TODO: allow to move all fields ? 
        // a workaround for a flaw in the demo system (http://dev.jqueryui.com/ticket/4375), ignore!
        $( "#dialog:ui-dialog" ).dialog( "destroy" );
        $( "#dialog-message-delete-group-forbidden" ).dialog({
            modal: true,
            buttons: {
                Ok: function() {
                    $( this ).dialog( "close" );
                }
            }
        });*/
    
        /*
        var index = $( "li", $tabs ).index( $( this ).parent() );
        $tabs.tabs( "remove", index );
        */
    });
});
</script>

{% endblock %}