{% extends 'StrixosWidgetBundle::layout.html.twig' %}

{% block title %}StrixOS - Edit Attribute Set{% endblock %}

{% block content_menu_more %}
    {{ parent() }}
    <li>
        <a href="{{ path('strixos_catalog_set_index') }}" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-primary" role="button">
            <span class="ui-button-icon-primary ui-icon ui-icon-fugue-ui-button-navigation-back"></span><span class="ui-button-text">Back to list</span>
        </a>
    </li>
{% endblock %}

{% block content %}

    {% form_theme form 'StrixosWidgetBundle:Form:fields.html.twig' %}
    
    <!-- TODO: drive from type ? -->
    {% if form.id.vars.value > 0 %}
    <form action="{{ path('strixos_catalog_set_save') }}" method="post" {{ form_enctype(form) }}>
    {% else %}
    <form action="{{ path('strixos_catalog_set_clone') }}" method="post" {{ form_enctype(form) }}>
    {% endif %}

        {{ form_errors(form) }}
    
        <div class="form-panel ui-corner-all">
            <h2>General</h2>
            {{ form_row(form.id) }}
            {{ form_row(form.code) }}
        </div>

        {% if form.id.vars.value <= 0 %}
        <div class="form-panel ui-corner-all">
            <h2>Copy from attribute set</h2>
            {{ form_row(form.copyfromset) }}
        </div>
        {% endif %}

        {% if form.id.vars.value > 0 %}

            <!-- set attributes -->
            <div class="ui-corner-all form-panel">

                <div id="tabs">
                    <h2>Groups and attributes</h2>
                    <!-- one tab by group -->
                    <ul>
                        {% for group in form.groups %}
                        <li><span class="ui-icon ui-icon-close">Remove Tab</span><a href="#tabs-{{ group.id.vars.value }}">{{ group.code.vars.value }}</a></li>
                        {% endfor %}

                        <a id="add_tab" href="#" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-icon-only" role="button" />
                            <span class="ui-button-icon-primary ui-icon ui-icon-fugue-plus-button"></span><span class="ui-button-text">Add a new group</span>
                        </a>
                    </ul>
                    <!-- tabs content -->
                    {% for group in form.groups %}
                    <div id="tabs-{{ group.id.vars.value }}">
                        <ul class="connectedSortable">
                            {% for attribute in group.attributes %}
                                <li class="ui-state-default ui-corner-all" id="{{ attribute.id.vars.value }}">{{ attribute.code.vars.value }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- available attributes -->
            <div class="form-panel ui-corner-all">
                <h2>Available attributes</h2>
                <ul id="available-list" class="connectedSortable">
                    {% for attribute in form.others %}
                        <li class="ui-state-default ui-corner-all" id="{{ attribute.id.vars.value }}">{{ attribute.code.vars.value }}</li>
                    {% endfor %}
                </ul>
            </div>

        {% endif %}

        {{ form_widget(form._token) }}

        {% if form.id.vars.value <= 0 %}
            <input type="submit" value="Save" class="ui-button ui-widget ui-state-default ui-corner-all" role="button" aria-disabled="false">
        {% else %}
            <p>TODO : deal with set changes</p>
        {% endif %}
    </form>
    
    <!-- add group dialog -->
    <div id="dialog" title="Add a new group">
        <form>
            <fieldset class="ui-helper-reset">
                <label for="tab_title">Code</label>
                <input type="text" name="tab_title" id="tab_title" value="" class="ui-widget-content ui-corner-all" />
            </fieldset>
        </form>
    </div>

    <div id="dialog-message-delete-group-forbidden" title="This group can't be delete" style="display:none">
        <p>
            <span class="ui-icon ui-icon-circle-check" style="float:left; margin:0 7px 50px 0;"></span>
            This group contains attributes, <b>please remove them before</b>.
        </p>
    </div>

<script>

function resetListMoves() {
    /* set groups and attributes */
    $( ".connectedSortable" ).sortable().disableSelection();
    var $tabs = $( "#tabs" ).tabs();
    var $tab_items = $( "ul:first li", $tabs ).droppable({
        accept: ".connectedSortable li",
        hoverClass: "ui-state-hover",
        drop: function( event, ui ) {
            var $item = $( this );
            var $list = $( $item.find( "a" ).attr( "href" ) )
                .find( ".connectedSortable" );
            ui.draggable.hide( "slow", function() {
                $tabs.tabs( "select", $tab_items.index( $item ) );
                $( this ).appendTo( $list ).show( "slow" );
            });
        }
    });
    
    /* remove an attribute from set */
    $( ".connectedSortable" ).sortable({
        connectWith: "#available-list",
        placeholder: "ui-state-highlight",
        cursor: "move",
        receive: function(event, ui) { ui.item.addClass("add-attribute").removeClass("remove-attribute") }
    }).disableSelection();
    
    /* add an available attribute to set */
    $( "#available-list" ).sortable({
        connectWith: ".connectedSortable",
        placeholder: "ui-state-highlight",
        cursor: "move",
        receive: function(event, ui) { ui.item.addClass("remove-attribute").removeClass("add-attribute") }
    }).disableSelection();
}

$(function() {

    resetListMoves();

    /* add a group */
    var $tab_title_input = $( "#tab_title"),
    $tab_content_input = $( "#tab_content" );
    var tab_counter = 2;

    // tabs init with a custom tab template and an "add" callback filling in the content
    var $tabs = $( "#tabs").tabs({
        tabTemplate: "<li><span class='ui-icon ui-icon-close'>Remove Group</span><a href='#{href}'>#{label}</a></li>",
        add: function( event, ui ) {
            var tab_content = '<ul class="connectedSortable"></ul>';
            $( ui.panel ).append(tab_content);
            /* aims to drag / drop from and to this new tab */
            resetListMoves();
        }
    });
    
    /* allow to sort tabs */
    $( "#tabs" ).tabs().find( ".ui-tabs-nav" ).sortable({ axis: "x" });

    // modal dialog init: custom buttons and a "close" callback reseting the form inside
    var $dialog = $( "#dialog" ).dialog({
        autoOpen: false,
        modal: true,
        buttons: {
            Add: function() {
                addTab();
                $( this ).dialog( "close" );
            },
            Cancel: function() {
                $( this ).dialog( "close" );
            }
        },
        open: function() {
            $tab_title_input.focus();
        },
        close: function() {
            $form[ 0 ].reset();
        }
    });

    // addTab form: calls addTab function on submit and closes the dialog
    var $form = $( "form", $dialog ).submit(function() {
        addTab();
        $dialog.dialog( "close" );
        return false;
    });

    // actual addTab function: adds new tab using the title input from the form above
    function addTab() {
        var tab_title = $tab_title_input.val() || "Tab " + tab_counter;
        $tabs.tabs( "add", "#tabs-" + tab_counter, tab_title );
        tab_counter++;
    }

    // addTab button: just opens the dialog
    $( "#add_tab" )
        /*.button()*/
        .click(function() {
            $dialog.dialog( "open" );
        });

    // close icon: removing the tab on click
    // note: closable tabs gonna be an option in the future - see http://dev.jqueryui.com/ticket/3924
    $( "#tabs span.ui-icon-close" ).live( "click", function() {
    
    
        /* popup add group doesn't work anymore */
    
        /* can't be deleted TODO: allow to move all attributes ? 
        // a workaround for a flaw in the demo system (http://dev.jqueryui.com/ticket/4375), ignore!
        $( "#dialog:ui-dialog" ).dialog( "destroy" );
        $( "#dialog-message-delete-group-forbidden" ).dialog({
            modal: true,
            buttons: {
                Ok: function() {
                    $( this ).dialog( "close" );
                }
            }
        });*/
    
        /*
        var index = $( "li", $tabs ).index( $( this ).parent() );
        $tabs.tabs( "remove", index );
        */
    });
});
</script>

{% endblock %}